<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Telegram Color Picker</title>
<style>
  body{font-family: Arial, Helvetica, sans-serif; text-align:center; padding:40px;}
  #picker{width:120px;height:120px;border:0;background:none}
  button{padding:10px 18px;font-size:16px}
  .muted{color:#666;font-size:13px}
  #status{margin-top:12px}
</style>
</head>
<body>
  <h2>Pick a color for collaborator</h2>

  <p class="muted" id="hint">This page expects chatID, collabID and cronID passed in the URL (the bot attaches them automatically).</p>

  <p>
    <input id="picker" type="color" value="#0078ff">
  </p>

  <p>
    <button id="sendBtn">Send Color</button>
  </p>

  <p id="status"></p>

<script>
// ...existing code...

const qp = new URLSearchParams(location.search);
const BACKEND = (qp.get('backend') || 'http://localhost:8081/pickcolor').trim();

// read params passed by bot
const CHAT_ID = qp.get('chatID') || '';
const COLLAB_ID = qp.get('collabID') || '';
const CRON_ID = qp.get('cronID') || '';

function parseHex(h){
  if(!h || h[0] !== '#') return null;
  if(h.length === 7){
    return [
      parseInt(h.substr(1,2),16),
      parseInt(h.substr(3,2),16),
      parseInt(h.substr(5,2),16),
      255
    ];
  }
  if(h.length === 4){
    return [
      parseInt(h[1]+h[1],16),
      parseInt(h[2]+h[2],16),
      parseInt(h[3]+h[3],16),
      255
    ];
  }
  return null;
}

async function sendColor(){
  const colorHex = document.getElementById('picker').value;
  const statusEl = document.getElementById('status');

  if(!CHAT_ID || !COLLAB_ID || !CRON_ID){
    statusEl.innerText = 'Missing chatID/collabID/cronID in URL. The bot should include them.';
    return;
  }
  const rgba = parseHex(colorHex);
  if(!rgba){
    statusEl.innerText = 'Invalid color';
    return;
  }

  statusEl.innerText = `Sending ${colorHex} to ${BACKEND}...`;

  try {
    const res = await fetch(BACKEND, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chatID: CHAT_ID,
        collabID: COLLAB_ID,
        cronID: CRON_ID,
        color: colorHex
      })
    });
    const txt = await res.text();
    if(res.ok){
      statusEl.innerText = `Sent ${colorHex}. Telegram preview should appear shortly.`;
      setTimeout(()=>{ try{ window.close() } catch(e){} }, 1200);
    } else {
      statusEl.innerText = `Server error: ${txt || res.statusText}`;
      console.warn('pickcolor response:', res.status, txt);
    }
  } catch(err){
    console.error('Network sendColor error:', err);
    statusEl.innerText = 'Network error sending color â€” see console / network tab for details.';
  }
}

document.getElementById('sendBtn').addEventListener('click', sendColor);
</script>
</body>
</html>
