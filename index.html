<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Telegram Color Picker</title>
<style>
  body{font-family: Arial, Helvetica, sans-serif; text-align:center; padding:40px;}
  #picker{width:120px;height:120px;border:0;background:none}
  button{padding:10px 18px;font-size:16px}
  .muted{color:#666;font-size:13px}
  #status{margin-top:12px}
</style>
</head>
<body>
  <h2>Pick a color for collaborator</h2>

  <p class="muted" id="hint">This page expects chatID, collabID and cronID passed in the URL (the bot attaches them automatically).</p>

  <p>
    <input id="picker" type="color" value="#0078ff">
  </p>

  <p>
    <button id="sendBtn">Send Color</button>
  </p>

  <p id="status"></p>

<script>
const qp = new URLSearchParams(location.search);

// backend URL is provided by the bot when opening the picker (query param `backend`).
// Fallback: try localhost:8081 (useful for local development).
const BACKEND = (qp.get('backend') || 'http://localhost:8081/pickcolor').replace(/\s+/g,'');

// Read required params from URL (bot should include them)
const CHAT_ID = qp.get('chatID') || '';
const COLLAB_ID = qp.get('collabID') || '';
const CRON_ID = qp.get('cronID') || '';

function parseHex(h){
  if(!h || h[0] !== '#') return null;
  if(h.length === 7){
    return [
      parseInt(h.substr(1,2),16),
      parseInt(h.substr(3,2),16),
      parseInt(h.substr(5,2),16),
      255
    ];
  }
  // support #RGB short form
  if(h.length === 4){
    return [
      parseInt(h[1]+h[1],16),
      parseInt(h[2]+h[2],16),
      parseInt(h[3]+h[3],16),
      255
    ];
  }
  return null;
}

function rgbaString(r,g,b,a){
  return `rgba(${r}, ${g}, ${b}, ${(a/255).toFixed(2)})`;
}

async function sendColor(){
  const colorHex = document.getElementById('picker').value;
  const statusEl = document.getElementById('status');

  // If the bot didn't pass params, show instructions and abort.
  if(!CHAT_ID || !COLLAB_ID || !CRON_ID){
    statusEl.innerText = 'Missing chatID / collabID / cronID. The bot should include them in the picker URL.';
    return;
  }

  const rgba = parseHex(colorHex);
  if(!rgba){
    statusEl.innerText = 'Invalid color';
    return;
  }

  statusEl.innerText = `Sending ${rgbaString(...rgba)}...`;

  const payload = {
    chatID: CHAT_ID,
    collabID: COLLAB_ID,
    cronID: CRON_ID,
    color: colorHex
  };

  try {
    const res = await fetch(BACKEND, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const txt = await res.text();
    if(res.ok){
      statusEl.innerText = `Sent: ${rgbaString(...rgba)} — Telegram preview should appear shortly.`;
      // optional: close the popup after a short delay
      setTimeout(()=>{ try { window.close(); } catch(e){} }, 1300);
    } else {
      statusEl.innerText = `Error: ${txt || res.statusText}`;
    }
  } catch(err){
    console.error(err);
    statusEl.innerText = 'Network error sending color';
  }
}

document.getElementById('sendBtn').addEventListener('click', sendColor);

// small UX: if required params missing, expose them for debugging (but keep hidden)
(function init(){
  if(!CHAT_ID || !COLLAB_ID || !CRON_ID){
    document.getElementById('hint').innerText = 'Missing params in URL. For quick testing you can add ?chatID=...&collabID=...&cronID=...&backend=...';
  } else {
    // hide hint (not necessary) and make UI minimal
    document.getElementById('hint').innerText = 'Ready — color will be sent directly to the bot.';
  }
})();
</script>
</body>
</html>
