<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Telegram Color Picker</title>
<style>
  body { font-family: Arial, Helvetica, sans-serif; text-align:center; padding:40px; }
  #picker { width:120px; height:120px; border:0; background:none; }
  #alpha { width:150px; margin-top:10px; }
  button { padding:10px 18px; font-size:16px; margin-top:20px; cursor:pointer; }
  #status { margin-top:12px; font-weight:bold; }
  .error { color:red; }
  .success { color:green; }
  .label { display:block; margin-top:12px; font-weight:bold; }
</style>
</head>
<body>
<h2>Pick a color for collaborator</h2>
<p class="muted" id="hint">This page expects chatID, collabID and cronID in the URL.</p>

<input type="color" id="picker" value="#0078ff">
<label class="label" for="alpha">Opacity: <span id="alphaVal">1.0</span></label>
<input type="range" id="alpha" min="0" max="1" step="0.01" value="1">

<p><button id="sendBtn">Send Color</button></p>
<p id="status"></p>

<script>
// URL parameters
const qp = new URLSearchParams(location.search);
const BACKEND = (qp.get('backend') || 'http://localhost:8081/pickcolor').trim();
const CHAT_ID = qp.get('chatID') || '';
const COLLAB_ID = qp.get('collabID') || '';
const CRON_ID = qp.get('cronID') || '';

// Alpha slider
const alphaInput = document.getElementById('alpha');
const alphaValEl = document.getElementById('alphaVal');
alphaInput.addEventListener('input', () => { alphaValEl.innerText = alphaInput.value; });

// Convert HEX + alpha to RGBA string
function toRGBA(hex, alpha){
  const r = parseInt(hex.substr(1,2),16);
  const g = parseInt(hex.substr(3,2),16);
  const b = parseInt(hex.substr(5,2),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

// Send color to backend
async function sendColor(){
  const colorHex = document.getElementById('picker').value;
  const alpha = document.getElementById('alpha').value;
  const statusEl = document.getElementById('status');
  const btn = document.getElementById('sendBtn');

  if(!CHAT_ID || !COLLAB_ID || !CRON_ID){
    statusEl.className = 'error';
    statusEl.innerText = 'Missing chatID/collabID/cronID in URL.';
    return;
  }

  const rgba = toRGBA(colorHex, alpha);
  statusEl.className = '';
  statusEl.innerText = `Sending ${rgba}...`;
  btn.disabled = true;

  try {
    const res = await fetch(BACKEND, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chatID: CHAT_ID,
        collabID: COLLAB_ID,
        cronID: CRON_ID,
        color: rgba
      })
    });
    const txt = await res.text();

    if(res.ok){
      statusEl.className = 'success';
      statusEl.innerText = `✅ Sent ${rgba} successfully!`;
      setTimeout(()=>{ try{ window.close() } catch(e){} }, 1200);
    } else {
      statusEl.className = 'error';
      statusEl.innerText = `Server error: ${txt || res.statusText}`;
      console.warn('pickcolor response:', res.status, txt);
    }
  } catch(err){
    statusEl.className = 'error';
    statusEl.innerText = 'Network error — see console.';
    console.error('Network error sending color:', err);
  } finally {
    btn.disabled = false;
  }
}

document.getElementById('sendBtn').addEventListener('click', sendColor);
</script>
</body>
</html>
